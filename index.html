<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    crossorigin="anonymous">

    <title>Bluetooth</title>


    <style>
        .btn {
            font-size: 1.5rem;
        }
        .display{
            display: grid;
            grid-gap: 4px;            
        }
    </style>
</head>

<body>
    <div class="display">

        <h1 id="VersionBluetooth">Version: 0.0.49</h1>
        <input type="text" id="name" value="OBD001910" placeholder="Device">

        <div class="display" id="btnDiv">
            <button class="btn" id='btnConnect' onclick="btnConnectClick()">Conectar</button>
            <button class="btn" id='btnDisConnect' onclick="btnDisconnectClick()" disabled>Desconectar</button>
            <button class="btn" id='btnReconnect' onclick="btnReconnectClick()" disabled>Reconectar</button>
        </div>
        <div id="logs"></div>
    </div>



</body>
<script src="./index.js"></script>
<!-- <script src="./bluetooth.js"></script> -->

<script>
    // esse script ser치 o bluetooth.js
    "use strict";

    var bluetoothDevice
    let queueServices = []

    function ConnectBluetooth(name, classDisable, elementEnabled) {
        

        log.innerHTML += `Criando conexao: ${name} <br/>`
        let serviceUUiD = '0000fefb-0000-1000-8000-00805f9b34fb'
        let optionalServices = serviceUUiD
            .split(/, ?/).map(s => s.startsWith('0x') ? parseInt(s) : s)
            .filter(s => s && BluetoothUUID.getService);

        // let options = { filters: [] }
        let options = { filters: [], optionalServices: optionalServices }
        if (name) {
            options.filters.push({ name })
        }
        // log.innerHTML += 'Request Device...' + JSON.stringify(options) + '</br>'
        navigator.bluetooth.requestDevice(options)
            .then(device => {
                bluetoothDevice = device;
                log.innerHTML += 'Conectando: ' + bluetoothDevice.name + '</br>'
                return bluetoothDevice.gatt.connect()
            })
            .then(server => {
                log.innerHTML += 'Conectado: ' + bluetoothDevice.name + '</br>'
                log.innerHTML += 'ID: ' + bluetoothDevice.id + '</br>'
                log.innerHTML += 'Pareado: ' + bluetoothDevice.gatt.connected + '</br>'
                log.innerHTML += 'Get services...' + '</br>'
                return server.getPrimaryServices()
            })
            .then(services => {
                let queue = Promise.resolve();
                disabledAllBtn(classDisable)
                elementEnabled.forEach(e => {
                    e.disabled = false
                })
                services.forEach(service => {
                    queue = queue.then(_ => service.getCharacteristics().then(characteristics => {
                        log.innerHTML += ('> Service: ' + service.uuid);
                        characteristics.forEach(characteristic => {
                            let sup = getSupportedProperties(characteristic)

                            let element = characteristic.uuid + ' ' + sup + '<br/>'
                            divBtn.innerHTML += `<button class = 'btn' id='btnRX' onclick=
                                'ServiceOf("${element.split(' ')[0]}")'>${element}</button>`


                        });
                    }));
                });
                return queue;
            })
            .catch(error => {
                log.innerHTML += ('Argh! ' + error);
            })


    }

    function DisconnectBluetooth(classDisable, elementEnabled) {
        
        disabledAllBtn(classDisable)
        elementEnabled.forEach(e => {
            e.disabled = false
        })
        if (!bluetoothDevice) {
            return;
        }
        log.innerHTML += 'Desconectando Bluetooth'
        if (bluetoothDevice.gatt.connected) {
            bluetoothDevice.gatt.disconnect();
        } else {
            log.innerHTML += 'Bluetooth j치 desconectado!!!'
        }
    }

    function ReconnectBluetooth(classDisable, elementEnabled) {
        disabledAllBtn(classDisable)
        elementEnabled.forEach(e => {
            e.disabled = false
        })
        if (!bluetoothDevice) {
            return;
        }
        log.innerHTML += 'Reconectando Bluetooth...'
        if (bluetoothDevice.gatt.connected) {
            log.innerHTML += 'Bluetooth j치 est치 conectado!!!'
        } else {
            log('Connecting to Bluetooth Device...');
            return bluetoothDevice.gatt.connect()
                .then(server => {
                    log('> Bluetooth Device connected');
                });
        }
    }

    function ServiceOf(uuid) {
        
        log.innerHTML += 'Servico ' + uuid + ' clickado</br>'
        let service = uuid.split('-')[0]
        log.innerHTML += 'Servico2 ' + service + ' clickado</br>'
    }

    // /* Utils */

    function getSupportedProperties(characteristic) {
        let supportedProperties = [];
        for (const p in characteristic.properties) {
            if (characteristic.properties[p] === true) {
                supportedProperties.push(p.toUpperCase());
            }
        }
        return '[' + supportedProperties.join(', ') + ']';
    }


    function disabledAllBtn(classe) {
        let btns = document.getElementsByClassName(classe)
        let obj = Object.values(btns)
        obj.forEach(e => {
            e.disabled = true
        })
    }
</script>


</html>
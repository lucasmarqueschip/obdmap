<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Bluetooth</title>


    <style>
        .btn {
            font-size: 1.5rem
        }
        .display{
            display: grid;
        }
    </style>
</head>

<body>
    <div class="display">

        <h1>Version: 0.0.11</h1>
        <input type="text" id="service" placeholder="Service">
        <input type="text" id="name" value="OBD001910" placeholder="Device">
        <input type="text" id="namePrefix" placeholder="Device Prefix">
        <button class = "btn" id='btnConnect' onclick="ConnectBluetooth()">Conectar</button>
        <button class = "btn" id='btnReadService' onclick="ReadServices()">Ler Serviços</button>
        <button class = "btn" id='btnRX' onclick="RX()">Receber</button>
        <div id="logs"></div>
    </div>



    <script>
        var bluetoothDevice;
        var div = document.getElementById('logs')
        let queueServices = []
        function ConnectBluetooth() {

            let options = { filters: [] };

            let filterService = document.querySelector('#service').value;
            if (filterService.startsWith('0x')) {
                filterService = parseInt(filterService);
            }
            if (filterService) {
                options.filters.push({ services: [filterService] });
            }

            let filterName = document.querySelector('#name').value;
            if (filterName) {
                options.filters.push({ name: filterName });
            }

            let filterNamePrefix = document.querySelector('#namePrefix').value;
            if (filterNamePrefix) {
                options.filters.push({ namePrefix: filterNamePrefix });
            }
            div.innerHTML += 'Conectando...' + JSON.stringify(options) + '</br>'


            bluetoothDevice = null;

            navigator.bluetooth.requestDevice(options)
                .then(device => {
                    bluetoothDevice = device;
                    return connect();
                })
                .catch(error => {
                    div.innerHTML += 'Error: ' + error + '</br>'
                });

        }



        function connect() {
            div.innerHTML += 'Conectando em ' + bluetoothDevice.name + '</br>'
            return bluetoothDevice.gatt.connect()
                .then(server => {
                    div.innerHTML += 'Conectado: ' + bluetoothDevice.name + '</br>'
                    div.innerHTML += 'ID: ' + bluetoothDevice.id + '</br>'
                    div.innerHTML += 'Connected: ' + bluetoothDevice.gatt.connected + '</br>'
                });
        }

        function ReadServices() {
            // Validate services UUID entered by user first.
            let service = '0000fefb-0000-1000-8000-00805f9b34fb'
            let optionalServices = service
                .split(/, ?/).map(s => s.startsWith('0x') ? parseInt(s) : s)
                .filter(s => s && BluetoothUUID.getService);



            div.innerHTML += 'Conectando...' + '</br>'
            navigator.bluetooth.requestDevice({
                // filters: [...] <- Prefer filters to save energy & show relevant devices.
                acceptAllDevices: true,
                optionalServices: optionalServices
            })
                .then(device => {
                    div.innerHTML += 'Conectando server...' + '</br>'
                    return device.gatt.connect();
                })
                .then(server => {
                    // Note that we could also get all services that match a specific UUID by
                    // passing it to getPrimaryServices().
                    div.innerHTML += 'Conectado!...' + '</br>'
                    return server.getPrimaryServices();
                })
                .then(services => {
                    div.innerHTML += 'Lendo Serviços...' + '</br>'
                    let queue = Promise.resolve();
                    services.forEach(service => {
                        queue = queue.then(_ => service.getCharacteristics().then(characteristics => {
                            div.innerHTML += ('> Service: ' + service.uuid);
                            characteristics.forEach(characteristic => {
                                let sup = getSupportedProperties(characteristic)
                                div.innerHTML += ('>> Characteristic: ' + characteristic.uuid + ' ' + sup);
                                queueServices.push = characteristic.uuid + ' ' + sup
                            });
                        }));
                    });
                    return queue;
                })
                .catch(error => {
                    div.innerHTML += ('Argh! ' + error);
                });
        }

        function RX(){
            let queue = ReadServices()
            queueServices.forEach(element => {
                div.innerHTML += 'RX INIT...queue: ' + element + '</br>'
            });            
        }

        /* Utils */

        function getSupportedProperties(characteristic) {
            let supportedProperties = [];
            for (const p in characteristic.properties) {
                if (characteristic.properties[p] === true) {
                    supportedProperties.push(p.toUpperCase());
                }
            }
            return '[' + supportedProperties.join(', ') + ']';
        }
    </script>

</body>

</html>